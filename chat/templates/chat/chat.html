{% extends 'chat/base.html' %}
{% load static %}

{% block content %}
<div id="frame">
  <div id="sidepanel">
    <div id="profile">
      <div class="wrap">
        <img id="profile-img" src="http://emilcarlsson.se/assets/mikeross.png" class="online" alt="" />
        <p>{{ username }}</p>
        <i class="fa fa-chevron-down expand-button" aria-hidden="true"></i>
        <div id="status-options">
          <ul>
            <li id="status-online" class="active"><span class="status-circle"></span> <p>Online</p></li>
            <li id="status-offline"><span class="status-circle"></span> <p>Offline</p></li>
          </ul>
        </div>
      </div>
    </div>
    <div id="search">
      <label for=""><i class="fa fa-search" aria-hidden="true"></i></label>
      <input type="text" placeholder="Search contacts..." />
    </div>

    <!-- total contacts displayed -->
    <div id="contacts">
      <ul>
        <li class="contact">
          <div class="wrap">
            <span class="contact-status online"></span>
            <img src="http://emilcarlsson.se/assets/louislitt.png" alt="" />
            <div class="meta">
              <p class="name">Louis Litt</p>
              <p class="preview">You just got LITT up, Mike.</p>
            </div>
          </div>
        </li>
        <li class="contact active">
          <div class="wrap">
            <span class="contact-status busy"></span>
            <img src="http://emilcarlsson.se/assets/harveyspecter.png" alt="" />
            <div class="meta">
              <p class="name">Harvey Specter</p>
              <p class="preview">Wrong. You take the gun, or you pull out a bigger one. Or, you call their bluff. Or, you do any one of a hundred and forty six other things.</p>
            </div>
          </div>
        </li>
      </ul>
    </div>


    <div id="bottom-bar">
      <button id="addcontact"><i class="fa fa-user-plus fa-fw" aria-hidden="true"></i> <span>Add contact</span></button>
      <button id="settings"><i class="fa fa-cog fa-fw" aria-hidden="true"></i> <span>Settings</span></button>
    </div>
  </div>


  <div class="content">
    <div class="contact-profile">
      <img src="http://emilcarlsson.se/assets/harveyspecter.png" alt="" />
      <p>Username</p>
    </div>

     <!-- message display -->
    <div class="messages">
      <ul id="chat-log">
        <li class="sent">
        </li>
        <li class="replies">
        </li>
      </ul>
    </div>


    <div class="message-input">
      <div class="wrap">
      <input type="text" id="chat-message-input" placeholder="Write your message..." />
      <i class="fa fa-paperclip attachment" aria-hidden="true"></i>
      <button class="submit" id="chat-message-submit"><i class="fa fa-paper-plane" aria-hidden="true"></i></button>
      </div>
    </div>
  </div>
</div>
{{ room_name|json_script:"room-name" }}

   <script>


        var username = '{{ username }}'
        const roomName = JSON.parse(document.getElementById('room-name').textContent);

        const chatSocket = new ReconnectingWebSocket(
            'ws://'
            + window.location.host
            + '/ws/chat/'
            + roomName
            + '/'
        );

        chatSocket.onmessage = function(e) {
            var data = JSON.parse(e.data);
            const data2 = (Object.values(data));
            
            if(data['command'] == "messages"){
                for(const value of data2[1]){
                  fetchMessage(value);
                }
            }else if (data['command'] == "new_message"){
              createMessage(data2[1]);
            }
        };

        function fetchMessage(data){
          var author = data.author;
          var content = data.content;

          var pTag = document.createElement('p');
          pTag.innerText = content;

          
          var msgListTag = document.createElement('li');
          

          if(author == username){
            msgListTag.className = 'sent';
            msgListTag.appendChild(pTag);
            document.getElementById('chat-log').appendChild(msgListTag);

          } else{
            msgListTag.className = 'replies';
            msgListTag.appendChild(pTag);
            document.getElementById('chat-log').appendChild(msgListTag);
          }
        }

        function createMessage(data){
          // console.log("createMessage");
          var author = data.author;
          var content = data.content;

          var pTag = document.createElement('p');
          pTag.innerText = content;

          
          var msgListTag = document.createElement('li');
          

          if(author == username){
            msgListTag.className = 'sent';
            msgListTag.appendChild(pTag);
            document.getElementById('chat-log').appendChild(msgListTag);

          } else{
            msgListTag.className = 'replies';
            msgListTag.appendChild(pTag);
            document.getElementById('chat-log').appendChild(msgListTag);
          }

          // console.log(data);
        }

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        chatSocket.onopen = function(e){
            fetch_messages();
        }

        function fetch_messages(){
            chatSocket.send(JSON.stringify({'command':'fetch_messages'}));
        }

        document.getElementById("chat-message-input").addEventListener("keypress", function(e){
            if (e.code === 'Enter') {  // enter, return
                e.preventDefault();
                document.getElementById('chat-message-submit').click();
            }
        });

        document.getElementById('chat-message-submit').onclick = function(e) {
            const messageInputDom = document.getElementById('chat-message-input');
            const message = messageInputDom.value;
            console.log("message", message);
                chatSocket.send(JSON.stringify({
                    'command': 'new_message',
                    'message': message,
                    'from': username
                })
            );
            document.getElementById('chat-message-input').value='';
        };
    </script>

{% endblock %}
